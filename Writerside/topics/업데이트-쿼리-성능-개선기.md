# 업데이트 쿼리 성능 개선기

## 문제 상황

고객사 서버(B2B)에서 이미지 업로드 상태 필드를 업데이트하는 스케줄러 로직으로 인해 과도한 CPU 점유가 다른 프로세스에 영향을 주는 상황이 발생했다.

스케줄러를 통해 5분에 한 번씩 업로드가 끝난 이미지를 조회하고 문서 테이블과 조인하여 업데이트 쿼리를 날리는 방식으로 동작하고 있다.

로그를 확인하니 이 스케줄러가 실행되는 동안 CPU 점유율이 1200%까지 올라가는 현상이 발생한 것을 확인할 수 있었다.

## 문제 원인

이 문제에 대한 원인을 사양적인 문제와 쿼리 자체의 문제로 나눌 수 있었다.

사양적인 관점으로 보면 이미지 업로드 상태 필드를 사용하지 않는 방법이 있다.

상태 필드의 사용처가 이미지 업로드가 다 되지 않았다면, 사용자가 이미지를 보다가 안 올라온 이미지는 볼 수 없을 것이고 이를 방지하기 위해 필드를 사용하고 있다. 

따라서 상태 필드가 필요한 이유는 이미지 업로드가 전부 완료된 이후에 사용자에게 이미지를 보여주기 위함이다.

하지만 이미지가 올라간 부분까지만 보여주고 나머지는 보여주지 않는 방법도 있다고 생각했다.

대부분의 경우 이미지가 올라가는 속도가 빠르기 때문에 사용자가 이미지를 보다가 업로드가 완료되지 않은 이미지를 보게 될 확률은 낮고 많은 이미지를 올리는 경우에는 
사용자가 어느정도 감내를 할 수 있을 것이라고 생각했다.

그리고 스케줄러의 주기가 5분이기 때문에 이미지의 업로드 속도와 상관없이 사용자가 이미지를 보기 위해서는 최소 5분을 기다려야 하기 때문에 이 필드를 사용하지 않는 방법도 괜찮을 것이라 생각했다.

이 방법의 장점과 단점은 다음과 같다.

- 장점
  - 업데이트 스케줄러가 필요 없어지므로 부하를 주는 원인 자체가 사라진다.
  - 이미지 업로드 속도와 상관없이 스케줄러의 주기만큼 기다려야 하는 문제가 해결된다.
- 단점
  - 사용자가 업로드된 이미지를 보다가 업로드가 완료되지 않은 이미지를 보게 될 수 있다.
  - UI 작업과 고객사 패치도 필요하다.

- 규모가 큰 테이블 간의 조인
- 데이터가 많은 테이블의 Update 부하
- 스케줄링 자체 (or 처리 속도에 비해 짧은 스케줄링 주기)

이라고 생각했고 이를 해결하기 위한 방법으로 다음과 같은 것들을 고려했다.

## 문제 해결

## 마무리
