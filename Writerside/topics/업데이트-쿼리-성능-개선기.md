# 업데이트 쿼리 성능 개선기

## 문제 상황과 원인

고객사 서버(B2B)에서 이미지 업로드 상태 필드를 업데이트하는 스케줄러 로직으로 인해 과도한 CPU 점유가 다른 프로세스에 영향을 주는 상황이 발생했다.

스케줄러를 통해 5분에 한 번씩 업로드가 끝난 이미지를 조회하고 문서 테이블과 조인하여 업데이트 쿼리를 날리는 방식으로 동작하고 있다.

로그를 확인하니 이 스케줄러가 실행되는 동안 CPU 점유율이 1200%까지 올라가는 현상이 발생한 것을 확인할 수 있었다.

## 문제 해결 방안

이 문제에 대한 원인을 사양적인 문제와 쿼리 자체의 문제로 나눌 수 있었다.

사양적인 관점으로 보면 이미지 업로드 상태 필드를 사용하지 않는 방법이 있다.

상태 필드의 사용처가 이미지 업로드가 다 되지 않았다면, 사용자가 이미지를 보다가 안 올라온 이미지는 볼 수 없을 것이고 이를 방지하기 위해 필드를 사용하고 있다. 

따라서 상태 필드가 필요한 이유는 이미지 업로드가 전부 완료된 이후에 사용자에게 이미지를 보여주기 위함이다.

하지만 이미지가 올라간 부분까지만 보여주고 나머지는 보여주지 않는 방법도 있다고 생각했다.

대부분의 경우 이미지가 올라가는 속도가 빠르기 때문에 사용자가 이미지를 보다가 업로드가 완료되지 않은 이미지를 보게 될 확률은 낮고 많은 이미지를 올리는 경우에는 
사용자가 어느정도 감내를 할 수 있을 것이라고 생각했다.

그리고 스케줄러의 주기가 5분이기 때문에 이미지의 업로드 속도와 상관없이 사용자가 이미지를 보기 위해서는 최소 5분을 기다려야 하기 때문에 이 필드를 사용하지 않는 방법도 괜찮을 것이라 생각했다.

이 방법의 장점과 단점은 다음과 같다.

- 장점
  - 업데이트 스케줄러가 필요 없어지므로 부하를 주는 원인 자체가 사라진다.
  - 이미지 업로드 속도와 상관없이 스케줄러의 주기만큼 기다려야 하는 문제도 부가적으로 해결된다.
- 단점
  - 사용자가 업로드된 이미지를 보다가 업로드가 완료되지 않은 이미지를 보게 될 수 있다.
  - UI 작업과 고객사 패치도 필요하다.

기술적인 관점으로 보면 업데이트 쿼리 자체의 성능과 짧은 스케줄링에 의한 지속적인 부하가 문제였다.

문제가 되는 쿼리를 비슷하게 재현해보면 다음과 같다.

```sql
UPDATE document_log
SET upload_status = 'FIN'
WHERE upload_status != 'FIN'
  AND transaction_id IN
      (SELECT transaction_id
       FROM (SELECT transaction_id, count(trans_id) as trans_count, file_count
             FROM file_log
             WHERE log_type = 1
               AND file_type = 2
               AND process_time >= '${last_updated_time}'
             GROUP BY trans_id, file_count) AS Z
       WHERE Z.trans_count >= Z.file_count);
```

document_log, file_log라는 규모가 큰 테이블 간의 조인, 데이터가 많은 document_log 테이블의 Update 부하, 쿼리의 인덱스를 제대로 타지 못하는 문제가 있었다.

따라서 업데이트 쿼리 자체의 성능을 개선하는 것보다 업데이트 스케줄링을 제거하고 매번 조회 요청을 날릴 때마다 상태를 조인하는 방식을 생각했다.

이 방법의 장점과 단점은 다음과 같다.

- 장점
  - UI 작업이 필요하지 않다.
  - 사용자는 기능의 변경없이 문제를 해결된다.
- 단점
  - 부하를 주는 원인 자체가 사라진다.
  - 조인에 의해 조회 성능이 느려질 수 있다.

## 문제 해결

팀장님, 사수님과 이 문제에 대해 논의한 결과 이 문제를 해결하기 위해 UI 패치나 사양 변경 같은 리스크는 조금 부담이 된다고 판단했다.

따라서 조회 요청시 상태를 조인하는 방식을 선택했다.

```sql
SELECT *
FROM document_log
WHERE log_type IN (1, 2)                                   -- 로그 타입 / 고정 / 1: 인쇄, 2: 검출
  AND print_log_show = 1                                   -- 로그 표시 여부 / 고정 / 0: 해당없음, 1: 표시, 2: 미표시
  AND print_status IN (0, 2, 4)                            -- 로그 인쇄 상태 / 고정 / 0: 해당 없음, 1: 미출력, 2: 출력(Approval), 4: 출력, 16: 미출력(블락)
  AND trans_id = 'trans_id'                                -- 인쇄 ID / 선택 / 미입력: 전체
  AND trace_id = 'trace_id'                                -- 인쇄 추적 ID / 선택 / 미입력: 전체
  AND user_code IN ('bjp', 'bjp2')                         -- 사용자 코드 / 선택 / 미입력: 전체
  AND user_name LIKE '박범' + '%'                            -- 사용자 이름 / 선택 / 미입력: 전체
  AND user_dept_code IN ('udc', 'udc2')                    -- 사용자 부서 코드 / 선택 / 미입력: 전체
  AND user_dept_name LIKE '개발' + '%'                       -- 사용자 부서 이름 / 선택 / 미입력: 전체
  AND sso_status IN ('ONLINE', 'TAKEOUT')                  -- SSO 상태 / 선택 / 미입력: 전체, ONLINE: 온라인, TAKEOUT: 반출, OFFLINE: 오프라인
  AND print_result IN (1, 2, 3, 4, 5, 6)                   -- 인쇄 결과(예외처리 적용 여부에 따른 인쇄 결과) / 선택 / 0: 해당없음(null 처리를 위한 값), 1: 일반 인쇄(예외처리 미적용), 2: 워터마크 인쇄(예외처리 미적용), 3 : URL, application, printer driver 등 정책에 의한 워터마크 예외, 4 : FXM 기간 워터마크 예외, 5 : FXM 첨부 문서 워터마크 예외, 6 : FXM 결재 후 워터마크 예외
  AND doc_name LIKE 'test' + '%'                           -- 파일명 / 선택 / 미입력: 전체
  AND ip = 'ip'                                            -- 인쇄 서버 IP / 선택 / 미입력: 전체
  AND device_id = 'device_id'                              -- 머신 ID / 선택 / 미입력: 전체
  AND printer_driver_name LIKE 'printer_driver_name' + '%' -- 프린터 드라이버명 / 선택 / 미입력: 전체
  AND application_name LIKE 'application_name' + '%'       -- 프린트 프로그램명 / 선택 / 미입력: 전체
  AND print_watermark_yn = 1                               -- 워터마크 여부 / 선택 / 미입력: 전체, 1: 워터마크 인쇄, 2: 일반 인쇄
  AND pattern_yn = 1                                       -- 패턴 검출 여부 / 선택 / 미입력: 전체 / 1: 검출, 2: 미검출
  AND masking_yn = 1                                       -- 마스킹 적용 여부 / 선택 / 미입력: 전체 / 1: 적용, 2: 미적용
  AND approval_yn = 1                                      -- 결재 필요 여부 / 선택 / 미입력: 전체 / 1: 필요, 2: 불필요
  AND (approval_type & 30) > 0                             -- 인쇄 승인 종류(결재 필요 여부) / 선택 / 1 : 해당 없음, 2 : 인쇄 시 무조건 결재, 4 : 검출 문서 인쇄 예외, 8 : 마스킹 인쇄 예외, 16 : 워터마크 인쇄 예외 / 비트 연산
  AND print_date BETWEEN 1687273200000 AND 1687446000000   -- 기간 / 필수
ORDER BY print_date DESC
LIMIT 200 OFFSET 0 -- 페이징 / 고정
;
```

```sql
SELECT log_id,
       trans_id,
       user_code,
       user_name,
       user_dept_code,
       user_dept_name,
       doc_name,
       location_type,
       log_type,
       print_watermark_yn,
       print_log_show,
       print_log_text_file_show,
       print_log_image_file_show,
       print_image_upload_status,
       total_print_page_count,
       print_date,
       CASE WHEN file_log_trans_id IS NULL THEN 0 ELSE 3 END AS print_image_upload_status
FROM (SELECT log_id,
             trans_id,
             user_code,
             user_name,
             user_dept_code,
             user_dept_name,
             doc_name,
             location_type,
             log_type,
             print_watermark_yn,
             print_log_show,
             print_log_text_file_show,
             print_log_image_file_show,
             print_image_upload_status,
             total_print_page_count,
             print_date
      FROM document_log
      WHERE log_type IN (1, 2)                                 -- 로그 타입 / 고정 / 1: 인쇄, 2: 검출
        AND print_log_show = 1                                 -- 로그 표시 여부 / 고정 / 0: 해당없음, 1: 표시, 2: 미표시
        AND print_status IN (0, 2, 4)                          -- 로그 인쇄 상태 / 고정 / 0: 해당 없음, 1: 미출력, 2: 출력(Approval), 4: 출력, 16: 미출력(블락)
--         AND trans_id = 'trans_id'                                -- 인쇄 ID / 선택 / 미입력: 전체
--         AND trace_id = 'trace_id'                                -- 인쇄 추적 ID / 선택 / 미입력: 전체
--         AND user_code IN ('bjp', 'bjp2')                         -- 사용자 코드 / 선택 / 미입력: 전체
--         AND user_name LIKE '박범' + '%'                            -- 사용자 이름 / 선택 / 미입력: 전체
--         AND user_dept_code IN ('udc', 'udc2')                    -- 사용자 부서 코드 / 선택 / 미입력: 전체
--         AND user_dept_name LIKE '개발' + '%'                       -- 사용자 부서 이름 / 선택 / 미입력: 전체
--         AND sso_status IN ('ONLINE', 'TAKEOUT')                  -- SSO 상태 / 선택 / 미입력: 전체, ONLINE: 온라인, TAKEOUT: 반출, OFFLINE: 오프라인
--         AND print_result IN (1, 2, 3, 4, 5, 6)                   -- 인쇄 결과(예외처리 적용 여부에 따른 인쇄 결과) / 선택 / 0: 해당없음(null 처리를 위한 값), 1: 일반 인쇄(예외처리 미적용), 2: 워터마크 인쇄(예외처리 미적용), 3 : URL, application, printer driver 등 정책에 의한 워터마크 예외, 4 : FXM 기간 워터마크 예외, 5 : FXM 첨부 문서 워터마크 예외, 6 : FXM 결재 후 워터마크 예외
--         AND doc_name LIKE 'test' + '%'                           -- 파일명 / 선택 / 미입력: 전체
--         AND ip = 'ip'                                            -- 인쇄 서버 IP / 선택 / 미입력: 전체
--         AND device_id = 'device_id'                              -- 머신 ID / 선택 / 미입력: 전체
--         AND printer_driver_name LIKE 'printer_driver_name' + '%' -- 프린터 드라이버명 / 선택 / 미입력: 전체
--         AND application_name LIKE 'application_name' + '%'       -- 프린트 프로그램명 / 선택 / 미입력: 전체
--         AND print_watermark_yn = 1                               -- 워터마크 여부 / 선택 / 미입력: 전체, 1: 워터마크 인쇄, 2: 일반 인쇄
--         AND pattern_yn = 1                                       -- 패턴 검출 여부 / 선택 / 미입력: 전체 / 1: 검출, 2: 미검출
--         AND masking_yn = 1                                       -- 마스킹 적용 여부 / 선택 / 미입력: 전체 / 1: 적용, 2: 미적용
--         AND approval_yn = 1                                      -- 결재 필요 여부 / 선택 / 미입력: 전체 / 1: 필요, 2: 불필요
--         AND (approval_type & 30) > 0                             -- 인쇄 승인 종류(결재 필요 여부) / 선택 / 1 : 해당 없음, 2 : 인쇄 시 무조건 결재, 4 : 검출 문서 인쇄 예외, 8 : 마스킹 인쇄 예외, 16 : 워터마크 인쇄 예외 / 비트 연산
        AND print_date BETWEEN 1687273200000 AND 1687446000000 -- 기간 / 필수
      ORDER BY print_date DESC
      LIMIT 200 OFFSET 0) AS print_log
         LEFT OUTER JOIN
     (SELECT trans_id AS file_log_trans_id
      FROM file_log
      WHERE log_type = 1
        AND file_type = 2
      GROUP BY trans_id, file_count
      HAVING COUNT(trans_id) >= file_count) AS file_log
     ON file_log_trans_id = trans_id;

```

## 마무리
